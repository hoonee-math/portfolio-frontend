# Vue.js í”„ë¡ íŠ¸ì—”ë“œ CI/CD íŒŒì´í”„ë¼ì¸
name: Frontend CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        
      # 2. Node.js 22 í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          
      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci
        
      # 4. TypeScript íƒ€ìž… ì²´í¬ ë° ë¹Œë“œ
      - name: Type check and build
        run: npm run build
        
      # 5. ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸
      - name: Verify build output
        run: |
          echo "=== Build Output Check ==="
          ls -la dist/
          echo "=== dist/index.html Content ==="
          head -20 dist/index.html
          echo "=== Build Size Information ==="
          du -sh dist/
          
      # 6. ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ë””ë²„ê¹…ìš©)
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: dist/
          retention-days: 1
          
      # 7. SSHë¥¼ í†µí•œ ì„œë²„ ë°°í¬ (main ë¸Œëžœì¹˜ë§Œ)
      - name: Deploy to server
        if: github.ref == 'refs/heads/main'
        run: |
          # SSH í‚¤ ì„¤ì •
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # known_hosts ì¶”ê°€ (ë³´ì•ˆ ê°•í™”)
          ssh-keyscan -H -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
          echo "=== ê¸°ì¡´ íŒŒì¼ ë°±ì—… ==="
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            cd /home/hooneeubuntu/services/frontend/portfolio/
            if [ -f index.html ]; then
              echo 'Creating backup...'
              cp -r . ../portfolio_backup_$(date +%Y%m%d_%H%M%S)/
              echo 'Backup created successfully'
            fi
          "
          
          echo "=== ìƒˆ íŒŒì¼ ì—…ë¡œë“œ ==="
          scp -i ~/.ssh/id_rsa -P ${{ secrets.SERVER_PORT }} -r dist/* ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/hooneeubuntu/services/frontend/portfolio/
          
          echo "=== ë°°í¬ ì™„ë£Œ í™•ì¸ ==="
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            cd /home/hooneeubuntu/services/frontend/portfolio/
            echo '=== Deployed Files ==='
            ls -la
            echo '=== index.html Check ==='
            if [ -f index.html ]; then
              echo 'index.html exists - Deployment SUCCESS!'
              head -5 index.html
            else
              echo 'index.html not found - Deployment FAILED!'
              exit 1
            fi
          "
          
      # 8. ë°°í¬ ì„±ê³µ ì•Œë¦¼
      - name: Deployment success notification
        if: success() && github.ref == 'refs/heads/main'
        run: |
          echo "ðŸš€ Frontend deployment completed successfully!"
          echo "Website: https://hoonee-math.info/"
          echo "Build size: $(du -sh dist/ | cut -f1)"
          echo "Commit: ${{ github.sha }}"
          
      # 9. ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
      - name: Rollback on failure
        if: failure() && github.ref == 'refs/heads/main'
        run: |
          echo "âŒ Deployment failed. Starting rollback..."
          
          # SSH í‚¤ ë‹¤ì‹œ ì„¤ì • (ì‹¤íŒ¨ ìƒí™©ì—ì„œëŠ” í‚¤ê°€ ì—†ì„ ìˆ˜ ìžˆìŒ)
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # known_hosts ì¶”ê°€
          ssh-keyscan -H -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
          # ë¡¤ë°± ì‹¤í–‰
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            cd /home/hooneeubuntu/services/frontend/
            LATEST_BACKUP=\$(ls -t portfolio_backup_* 2>/dev/null | head -1)
            if [ -n \"\$LATEST_BACKUP\" ]; then
              echo 'Restoring from backup: '\$LATEST_BACKUP
              rm -rf portfolio/*
              cp -r \$LATEST_BACKUP/* portfolio/
              echo 'Rollback completed successfully'
            else
              echo 'No backup found for rollback'
            fi
          "
          exit 1
